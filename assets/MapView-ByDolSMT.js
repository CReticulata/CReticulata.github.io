import{k as B,m as v,N as Q,n as V,o as _,q as C,C as b}from"./Note-BbBG63Ac.js";import{_ as W,U as P,r as c,w as x,q as E,L as R,X as n,W as m,P as r,M as z,$ as U,a0 as M,Y as S}from"./index-DO6CtBYk.js";const h={__name:"MapView",setup(O){const l=P(),s=c({user:l.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[]}),w=c(""),u=c(!1),p=c(!1),g=c(!1);let i,d;async function y(){const t=l.userLocation,{Map:o}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");i=new o(document.getElementById("map"),{zoom:18,center:t,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new e({map:i,position:t,title:"目前位置"}),i.addListener("click",a=>{a.placeId&&q(a.placeId,i)})}async function q(t,o){const{Place:e}=await google.maps.importLibrary("places"),a=new e({id:t,requestedLanguage:"zh_Hant"});await a.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName"]}),L(t,a.displayName,{lat:a.location.lat(),lng:a.location.lng()},a.googleMapsURI,a.formattedAddress),I(a.location,o,a.displayName,a.formattedAddress)}async function I(t,o,e,a){const{InfoWindow:f}=await google.maps.importLibrary("maps");d=new f({position:t,content:A(e,a),maxWidth:250}),d.open(o),google.maps.event.addListener(d,"domready",function(){const N=document.querySelector(".create-note");N&&N.addEventListener("click",()=>{if(l.notes.find(k=>k.id===s.value.id)){p.value=!0,d.close();return}if(!l.user.ID){g.value=!0,d.close();return}u.value=!0})})}function A(t,o){return`
    <div class="info-window">
      <h6>${t}</h6>
      <p>${o}</p>
      <div class=info-window__button>
        <button class="create-note">新增筆記</button>
      </div>
    </div>`}l.userLocation&&y(),x(()=>l.userLocation,()=>{y()}),E(async()=>{const t=document.querySelector(".search-input input");await google.maps.importLibrary("places");const o=new google.maps.places.Autocomplete(t,{fields:["place_id","geometry","formatted_address","name","url"]});o.addListener("place_changed",()=>{d&&d.close();const e=o.getPlace();!e.geometry||!e.geometry.location||(e.geometry.viewport?i.fitBounds(e.geometry.viewport):(i.setCenter(e.geometry.location),i.setZoom(18)),L(e.place_id,e.name,{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},e.url,e.formatted_address),I(e.geometry.location,i,e.name,e.formatted_address))})});function D(t){d.close(),u.value=!1;const o=t;if(s.value={user:l.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[]},l.notes.find(e=>e.id===o.id)){p.value=!0;return}l.createNote(o)}function L(t,o,e,a,f){s.value.id=t,s.value.storeName=o,s.value.location=e,s.value.googlemapURL=a,s.value.address=f}return x(()=>l.user,()=>{s.value.user=l.user.ID}),(t,o)=>(z(),R("div",null,[n(B,{modelValue:w.value,"onUpdate:modelValue":o[0]||(o[0]=e=>w.value=e),class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},null,8,["modelValue"]),o[7]||(o[7]=m("div",{class:"separator row flex-center"},[m("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),o[8]||(o[8]=m("div",{id:"map"},null,-1)),n(v,{modelValue:u.value,"onUpdate:modelValue":o[2]||(o[2]=e=>u.value=e),persistent:""},{default:r(()=>[n(Q,{isCreate:!0,"onUpdate:isCreate":o[1]||(o[1]=e=>u.value=e),noteInput:s.value,"onCreate:note":D},null,8,["noteInput"])]),_:1},8,["modelValue"]),n(v,{modelValue:p.value,"onUpdate:modelValue":o[3]||(o[3]=e=>p.value=e)},{default:r(()=>[n(V,null,{default:r(()=>[n(_,{class:"row items-center"},{default:r(()=>[n(U,{name:"warning",color:"negative",size:"24px"}),o[5]||(o[5]=m("span",{class:"q-ml-sm"},"已經寫過這家店的筆記囉！",-1))]),_:1}),n(C,{align:"right"},{default:r(()=>[M(n(S,{flat:"",label:"OK",color:"primary"},null,512),[[b]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(v,{modelValue:g.value,"onUpdate:modelValue":o[4]||(o[4]=e=>g.value=e)},{default:r(()=>[n(V,{style:{width:"200px"}},{default:r(()=>[n(_,{class:"row items-center"},{default:r(()=>[n(U,{name:"warning",color:"negative",size:"24px"}),o[6]||(o[6]=m("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),n(C,{align:"right"},{default:r(()=>[M(n(S,{flat:"",label:"OK",color:"primary"},null,512),[[b]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},K=W(h,[["__scopeId","data-v-96d89e90"]]);export{K as default};
