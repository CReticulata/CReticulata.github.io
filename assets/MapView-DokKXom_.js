import{_ as X,V as ee,r as p,c as U,w as k,L as g,M as c,Y as f,Z as s,O as te,R as r,a1 as V,P as E,Q as R,a2 as D,N as Q,a3 as oe,a4 as ae,S as B,U as q,a5 as ne,a6 as se,a7 as P,$ as F,a0 as le}from"./index-CC9-M3vu.js";import{Q as re,k as O,l as W,m as ie,n as de}from"./QDialog-DLu1kmRT.js";import{N as $,b as ue,C as ce}from"./Note-D4lRPSsg.js";const me={class:"autocomplete"},pe={key:0,class:"suggestion-list"},ge={class:"list"},fe={key:0,class:"notes"},ve={__name:"MapView",setup(we){const n=ee(),l=p({user:n.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",city:"",photos:[]}),v=p(""),w=p([]),m=p(!1),T=U(()=>n.notes.find(e=>e.id===l.value.id)),z=U(()=>n.notes.find(e=>e.id===l.value.id&&e.user===n.user.ID)),L=p(!1),y=p(!1);let i,u,N=[];async function A(){const e=n.userLocation,{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:o}=await google.maps.importLibrary("marker");await google.maps.importLibrary("places"),i=new t(document.getElementById("map"),{zoom:18,center:e,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new o({map:i,position:e,title:"目前位置"}),S(),i.addListener("click",a=>{a.placeId&&_(a.placeId,i)})}async function S(){const{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");N.forEach(t=>{t.map=null}),N=[],N=[...n.notes].map(t=>{const o=document.createElement("div");o.classList.add("tomato");const a=document.createElement("img");a.src=new URL("/favicon-tomato.png",import.meta.url).href,o.appendChild(a);const d=new e({map:i,position:{lat:t.location.lat,lng:t.location.lng},content:o,title:t.storeName,gmpClickable:!0});return d.placeId=t.id,d}),N.forEach(t=>{t.addEventListener("click",()=>{t.placeId&&_(t.placeId,i)})})}async function _(e,t){const{Place:o}=await google.maps.importLibrary("places"),a=new o({id:e,requestedLanguage:"zh_Hant"});await a.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName","adrFormatAddress"]});const d=h(a.adrFormatAddress);M({placeId:e,storeName:a.displayName,location:{lat:a.location.lat(),lng:a.location.lng()},googlemapURL:a.googleMapsURI,address:a.formattedAddress,city:d}),b(a.location,t,a.displayName,a.formattedAddress)}async function b(e,t,o,a){const{InfoWindow:d}=await google.maps.importLibrary("maps");u&&u.close(),u=new d({position:e,content:H(o,a,T.value,z.value),maxWidth:250}),u.open(t),google.maps.event.addListener(u,"domready",function(){const I=document.querySelector(".review-note"),x=document.querySelector(".create-note");I&&I.addEventListener("click",()=>{y.value=!0,m.value=!0}),x&&x.addEventListener("click",()=>{if(!n.user.ID){L.value=!0,u.close();return}y.value=!1,m.value=!0})})}function H(e,t,o=!1,a=!1){return`
    <div class="info-window">
      <h6>${e}</h6>
      <p>${t}</p>
      <div class=info-window__button>
        ${o?'<button class="review-note">查看筆記</button>':""}
        ${a?"":'<button class="create-note">新增筆記</button>'}
      </div>
    </div>`}async function Z(){if(v.value===""){w.value=[];return}const e={input:v.value,locationBias:{radius:100,center:{lat:n.userLocation.lat,lng:n.userLocation.lng}}},{suggestions:t}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(e);w.value=t.map(o=>o.placePrediction)}function K(e){return e.Nq.Nh[3][0][0]}function Y(e){return e.Nq.Nh[3][1][0]}async function j(e){if(await e.fetchFields({fields:["id","viewport","location","formattedAddress","displayName","googleMapsURI","adrFormatAddress"]}),!e.viewport||!e.location)return;e.viewport?i.fitBounds(e.viewport):(i.setCenter(e.location),i.setZoom(18));const t=h(e.adrFormatAddress);M({placeId:e.id,storeName:e.displayName,location:{lat:e.location.lat(),lng:e.location.lng()},googlemapURL:e.googleMapsURI,address:e.formattedAddress,city:t}),b(e.location,i,e.displayName,e.formattedAddress),C()}function C(){v.value="",w.value=[]}function G(e){u.close(),m.value=!1;const t=e;l.value={user:n.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[],city:""},n.createNote(t)}function M({placeId:e,storeName:t,location:o,googlemapURL:a,address:d,city:I}){l.value.id=e,l.value.storeName=t,l.value.location=o,l.value.googlemapURL=a,l.value.address=d,l.value.city=I}function h(e){return new DOMParser().parseFromString(e,"text/html").querySelector(".region").textContent}function J(e){n.deleteNote(e),m.value=!1,u.close()}return A(),k(()=>n.userLocation,()=>{A()}),k(()=>n.user,()=>{l.value.user=n.user.ID}),k(()=>n.notes,()=>{S()}),(e,t)=>(c(),g("div",null,[f("div",me,[s(re,{modelValue:v.value,"onUpdate:modelValue":[t[0]||(t[0]=o=>v.value=o),Z],class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},{append:r(()=>[s(V,{name:"close",onClick:C,class:"cursor-pointer"})]),_:1},8,["modelValue"]),w.value.length>0?(c(),g("div",pe,[f("div",ge,[s(se,{bordered:"",separator:""},{default:r(()=>[(c(!0),g(E,null,R(w.value,(o,a)=>D((c(),Q(oe,{key:a,clickable:"",onClick:()=>j(o.toPlace())},{default:r(()=>[s(ae,null,{default:r(()=>[s(O,null,{default:r(()=>[B(q(K(o)),1)]),_:2},1024),s(O,{caption:""},{default:r(()=>[B(q(Y(o)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[ne]])),128))]),_:1})])])):te("",!0)]),t[8]||(t[8]=f("div",{class:"separator row flex-center"},[f("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),f("div",{id:"map",onTouchstart:t[1]||(t[1]=P(()=>{},["stop"])),onMousedown:t[2]||(t[2]=P(()=>{},["stop"]))},null,32),s(W,{modelValue:m.value,"onUpdate:modelValue":t[5]||(t[5]=o=>m.value=o),persistent:!y.value},{default:r(()=>[y.value?(c(),g("div",fe,[(c(!0),g(E,null,R(F(n).notes.filter(o=>o.id===l.value.id),o=>(c(),g("div",{key:o.id+o.user},[s($,{noteInput:o,"onUpdate:note":t[3]||(t[3]=a=>F(n).updateNote(a)),"onDelete:note":J},null,8,["noteInput"])]))),128))])):(c(),Q($,{key:1,isCreate:!0,"onUpdate:isNoteOpen":t[4]||(t[4]=o=>m.value=o),noteInput:l.value,"onCreate:note":G},null,8,["noteInput"]))]),_:1},8,["modelValue","persistent"]),s(W,{modelValue:L.value,"onUpdate:modelValue":t[6]||(t[6]=o=>L.value=o)},{default:r(()=>[s(ie,{style:{width:"200px"}},{default:r(()=>[s(de,{class:"row items-center"},{default:r(()=>[s(V,{name:"warning",color:"negative",size:"24px"}),t[7]||(t[7]=f("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),s(ue,{align:"right"},{default:r(()=>[D(s(le,{flat:"",label:"OK",color:"primary"},null,512),[[ce]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Le=X(ve,[["__scopeId","data-v-0e491143"]]);export{Le as default};
