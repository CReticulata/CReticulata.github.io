import{Q as k,k as y,l as _,m as x}from"./QDialog-BXHGBQFd.js";import{_ as E,V as P,r as m,w as C,q as W,L as O,Z as s,Y as p,a1 as M,R as r,M as z,a2 as S,a3 as U,$ as A}from"./index-CePM04CV.js";import{N as F,b as D,C as R}from"./Note-Dfn5wCcN.js";const $={__name:"MapView",setup(H){const a=P(),l=m({user:a.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",city:"",photos:[]}),L=m(""),u=m(!1),g=m(!1),w=m(!1);let i,d,f;async function I(){const n=a.userLocation,{Map:o}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");i=new o(document.getElementById("map"),{zoom:18,center:n,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new e({map:i,position:n,title:"目前位置"}),i.addListener("click",t=>{t.placeId&&h(t.placeId,i)})}async function h(n,o){const{Place:e}=await google.maps.importLibrary("places"),t=new e({id:n,requestedLanguage:"zh_Hant"});await t.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName","adrFormatAddress"]});const c=b(t.adrFormatAddress);V({placeId:n,storeName:t.displayName,location:{lat:t.location.lat(),lng:t.location.lng()},googlemapURL:t.googleMapsURI,address:t.formattedAddress,city:c}),N(t.location,o,t.displayName,t.formattedAddress)}async function N(n,o,e,t){const{InfoWindow:c}=await google.maps.importLibrary("maps");d=new c({position:n,content:q(e,t),maxWidth:250}),d.open(o),google.maps.event.addListener(d,"domready",function(){const v=document.querySelector(".create-note");v&&v.addEventListener("click",()=>{if(a.notes.find(Q=>Q.id===l.value.id)){g.value=!0,d.close();return}if(!a.user.ID){w.value=!0,d.close();return}u.value=!0})})}function q(n,o){return`
    <div class="info-window">
      <h6>${n}</h6>
      <p>${o}</p>
      <div class=info-window__button>
        <button class="create-note">新增筆記</button>
      </div>
    </div>`}I(),C(()=>a.userLocation,()=>{I(),f.setOptions({bounds:{north:a.userLocation.lat+.1,south:a.userLocation.lat-.1,east:a.userLocation.lng+.1,west:a.userLocation.lng-.1}})}),W(async()=>{const n=document.querySelector(".search-input input");await google.maps.importLibrary("places");const o={north:a.userLocation.lat+.1,south:a.userLocation.lat-.1,east:a.userLocation.lng+.1,west:a.userLocation.lng-.1};f=new google.maps.places.Autocomplete(n,{fields:["place_id","geometry","formatted_address","name","url","adr_address"],bounds:o}),f.addListener("place_changed",()=>{d&&d.close();const e=f.getPlace();if(!e.geometry||!e.geometry.location)return;e.geometry.viewport?i.fitBounds(e.geometry.viewport):(i.setCenter(e.geometry.location),i.setZoom(18));const t=b(e.adr_address);V({placeId:e.place_id,storeName:e.name,location:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},googlemapURL:e.url,address:e.formatted_address,city:t}),N(e.geometry.location,i,e.name,e.formatted_address)})});function B(n){d.close(),u.value=!1;const o=n;if(l.value={user:a.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[],city:""},a.notes.find(e=>e.id===o.id)){g.value=!0;return}a.createNote(o)}function V({placeId:n,storeName:o,location:e,googlemapURL:t,address:c,city:v}){l.value.id=n,l.value.storeName=o,l.value.location=e,l.value.googlemapURL=t,l.value.address=c,l.value.city=v}function b(n){return new DOMParser().parseFromString(n,"text/html").querySelector(".region").textContent}return C(()=>a.user,()=>{l.value.user=a.user.ID}),(n,o)=>(z(),O("div",null,[s(k,{modelValue:L.value,"onUpdate:modelValue":o[0]||(o[0]=e=>L.value=e),class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},null,8,["modelValue"]),o[9]||(o[9]=p("div",{class:"separator row flex-center"},[p("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),p("div",{id:"map",onTouchstart:o[1]||(o[1]=M(()=>{},["stop"])),onMousedown:o[2]||(o[2]=M(()=>{},["stop"]))},null,32),s(y,{modelValue:u.value,"onUpdate:modelValue":o[4]||(o[4]=e=>u.value=e),persistent:""},{default:r(()=>[s(F,{isCreate:!0,"onUpdate:isCreate":o[3]||(o[3]=e=>u.value=e),noteInput:l.value,"onCreate:note":B},null,8,["noteInput"])]),_:1},8,["modelValue"]),s(y,{modelValue:g.value,"onUpdate:modelValue":o[5]||(o[5]=e=>g.value=e)},{default:r(()=>[s(_,null,{default:r(()=>[s(x,{class:"row items-center"},{default:r(()=>[s(S,{name:"warning",color:"negative",size:"24px"}),o[7]||(o[7]=p("span",{class:"q-ml-sm"},"已經寫過這家店的筆記囉！",-1))]),_:1}),s(D,{align:"right"},{default:r(()=>[U(s(A,{flat:"",label:"OK",color:"primary"},null,512),[[R]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(y,{modelValue:w.value,"onUpdate:modelValue":o[6]||(o[6]=e=>w.value=e)},{default:r(()=>[s(_,{style:{width:"200px"}},{default:r(()=>[s(x,{class:"row items-center"},{default:r(()=>[s(S,{name:"warning",color:"negative",size:"24px"}),o[8]||(o[8]=p("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),s(D,{align:"right"},{default:r(()=>[U(s(A,{flat:"",label:"OK",color:"primary"},null,512),[[R]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Y=E($,[["__scopeId","data-v-15f6d35d"]]);export{Y as default};
