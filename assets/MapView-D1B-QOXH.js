import{_ as G,V as J,r as p,c as V,w as k,L as f,M as u,Y as g,Z as s,O as X,R as r,a1 as h,P as E,Q as R,a2 as D,N as Q,a3 as ee,a4 as te,S as P,U as B,a5 as oe,a6 as ae,a7 as O,$ as q,a0 as ne}from"./index-BwK8HcK2.js";import{Q as se,k as F,l as T,m as le,n as re}from"./QDialog-DOcWTuX0.js";import{N as W,b as ie,C as de}from"./Note-PEDhWFZw.js";const ce={class:"autocomplete"},ue={key:0,class:"suggestion-list"},me={class:"list"},pe={key:0,class:"notes"},fe={__name:"MapView",setup(ge){const n=J(),l=p({user:n.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",city:"",photos:[]}),v=p(""),w=p([]),m=p(!1),$=V(()=>n.notes.find(t=>t.id===l.value.id)),z=V(()=>n.notes.find(t=>t.id===l.value.id&&t.user===n.user.ID)),L=p(!1),y=p(!1);let i,c,I=[];async function b(){const t=n.userLocation,{Map:e}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:o}=await google.maps.importLibrary("marker");await google.maps.importLibrary("places"),i=new e(document.getElementById("map"),{zoom:18,center:t,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new o({map:i,position:t,title:"目前位置"}),x(),i.addListener("click",a=>{a.placeId&&A(a.placeId,i)})}async function x(){const{AdvancedMarkerElement:t}=await google.maps.importLibrary("marker");I.forEach(e=>{e.map=null}),I=[],I=[...n.notes].map(e=>{const o=document.createElement("div");o.classList.add("tomato");const a=document.createElement("img");a.src=new URL("/favicon-tomato.png",import.meta.url).href,o.appendChild(a);const d=new t({map:i,position:{lat:e.location.lat,lng:e.location.lng},content:o,title:e.storeName,gmpClickable:!0});return d.placeId=e.id,d}),I.forEach(e=>{e.addEventListener("click",()=>{e.placeId&&A(e.placeId,i)})})}async function A(t,e){const{Place:o}=await google.maps.importLibrary("places"),a=new o({id:t,requestedLanguage:"zh_Hant"});await a.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName","adrFormatAddress"]});const d=M(a.adrFormatAddress);S({placeId:t,storeName:a.displayName,location:{lat:a.location.lat(),lng:a.location.lng()},googlemapURL:a.googleMapsURI,address:a.formattedAddress,city:d}),_(a.location,e,a.displayName,a.formattedAddress)}async function _(t,e,o,a){const{InfoWindow:d}=await google.maps.importLibrary("maps");c&&c.close(),c=new d({position:t,content:j(o,a,$.value,z.value),maxWidth:250}),c.open(e),google.maps.event.addListener(c,"domready",function(){const N=document.querySelector(".review-note"),U=document.querySelector(".create-note");N&&N.addEventListener("click",()=>{y.value=!0,m.value=!0}),U&&U.addEventListener("click",()=>{if(!n.user.ID){L.value=!0,c.close();return}y.value=!1,m.value=!0})})}function j(t,e,o=!1,a=!1){return`
    <div class="info-window">
      <h6>${t}</h6>
      <p>${e}</p>
      <div class=info-window__button>
        ${o?'<button class="review-note">查看筆記</button>':""}
        ${a?"":'<button class="create-note">新增筆記</button>'}
      </div>
    </div>`}async function H(){if(v.value===""){w.value=[];return}const t={input:v.value,locationBias:{radius:100,center:{lat:n.userLocation.lat,lng:n.userLocation.lng}}},{suggestions:e}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(t);w.value=e.map(o=>({placePredictionObject:o.placePrediction,mainText:o.placePrediction.mainText||"",secondaryText:o.placePrediction.secondaryText||""}))}async function Z(t){if(await t.fetchFields({fields:["id","viewport","location","formattedAddress","displayName","googleMapsURI","adrFormatAddress"]}),!t.viewport||!t.location)return;t.viewport?i.fitBounds(t.viewport):(i.setCenter(t.location),i.setZoom(18));const e=M(t.adrFormatAddress);S({placeId:t.id,storeName:t.displayName,location:{lat:t.location.lat(),lng:t.location.lng()},googlemapURL:t.googleMapsURI,address:t.formattedAddress,city:e}),_(t.location,i,t.displayName,t.formattedAddress),C()}function C(){v.value="",w.value=[]}function K(t){c.close(),m.value=!1;const e=t;l.value={user:n.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[],city:""},n.createNote(e)}function S({placeId:t,storeName:e,location:o,googlemapURL:a,address:d,city:N}){l.value.id=t,l.value.storeName=e,l.value.location=o,l.value.googlemapURL=a,l.value.address=d,l.value.city=N}function M(t){return new DOMParser().parseFromString(t,"text/html").querySelector(".region").textContent}function Y(t){n.deleteNote(t),m.value=!1,c.close()}return b(),k(()=>n.userLocation,()=>{b()}),k(()=>n.user,()=>{l.value.user=n.user.ID}),k(()=>n.notes,()=>{x()}),(t,e)=>(u(),f("div",null,[g("div",ce,[s(se,{modelValue:v.value,"onUpdate:modelValue":[e[0]||(e[0]=o=>v.value=o),H],class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},{append:r(()=>[s(h,{name:"close",onClick:C,class:"cursor-pointer"})]),_:1},8,["modelValue"]),w.value.length>0?(u(),f("div",ue,[g("div",me,[s(ae,{bordered:"",separator:""},{default:r(()=>[(u(!0),f(E,null,R(w.value,(o,a)=>D((u(),Q(ee,{key:a,clickable:"",onClick:()=>Z(o.placePredictionObject.toPlace())},{default:r(()=>[s(te,null,{default:r(()=>[s(F,null,{default:r(()=>[P(B(o.mainText),1)]),_:2},1024),s(F,{caption:""},{default:r(()=>[P(B(o.secondaryText),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[oe]])),128))]),_:1})])])):X("",!0)]),e[8]||(e[8]=g("div",{class:"separator row flex-center"},[g("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),g("div",{id:"map",onTouchstart:e[1]||(e[1]=O(()=>{},["stop"])),onMousedown:e[2]||(e[2]=O(()=>{},["stop"]))},null,32),s(T,{modelValue:m.value,"onUpdate:modelValue":e[5]||(e[5]=o=>m.value=o),persistent:!y.value},{default:r(()=>[y.value?(u(),f("div",pe,[(u(!0),f(E,null,R(q(n).notes.filter(o=>o.id===l.value.id),o=>(u(),f("div",{key:o.id+o.user},[s(W,{noteInput:o,"onUpdate:note":e[3]||(e[3]=a=>q(n).updateNote(a)),"onDelete:note":Y},null,8,["noteInput"])]))),128))])):(u(),Q(W,{key:1,isCreate:!0,"onUpdate:isNoteOpen":e[4]||(e[4]=o=>m.value=o),noteInput:l.value,"onCreate:note":K},null,8,["noteInput"]))]),_:1},8,["modelValue","persistent"]),s(T,{modelValue:L.value,"onUpdate:modelValue":e[6]||(e[6]=o=>L.value=o)},{default:r(()=>[s(le,{style:{width:"200px"}},{default:r(()=>[s(re,{class:"row items-center"},{default:r(()=>[s(h,{name:"warning",color:"negative",size:"24px"}),e[7]||(e[7]=g("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),s(ie,{align:"right"},{default:r(()=>[D(s(ne,{flat:"",label:"OK",color:"primary"},null,512),[[de]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Ie=G(fe,[["__scopeId","data-v-97b4fc1c"]]);export{Ie as default};
