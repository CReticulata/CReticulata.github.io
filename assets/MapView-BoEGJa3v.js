import{Q as k,k as y,l as x,m as C}from"./QDialog-DoeLT2tw.js";import{_ as E,V as P,r as m,w as M,q as W,L as O,Z as n,Y as p,a1 as S,R as r,M as z,a2 as U,a3 as D,$ as A}from"./index-CKzaWGog.js";import{N as F,b as R,C as h}from"./Note-CLShERj1.js";const $={__name:"MapView",setup(H){const t=P(),l=m({user:t.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",city:"",photos:[]}),L=m(""),u=m(!1),g=m(!1),w=m(!1);let i,d,f;async function I(){const s=t.userLocation,{Map:o}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");i=new o(document.getElementById("map"),{zoom:18,center:s,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new e({map:i,position:s,title:"目前位置"}),i.addListener("click",a=>{a.placeId&&q(a.placeId,i)})}async function q(s,o){const{Place:e}=await google.maps.importLibrary("places"),a=new e({id:s,requestedLanguage:"zh_Hant"});await a.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName","adrFormatAddress"]});const c=b(a.adrFormatAddress);V({placeId:s,storeName:a.displayName,location:{lat:a.location.lat(),lng:a.location.lng()},googlemapURL:a.googleMapsURI,address:a.formattedAddress,city:c}),N(a.location,o,a.displayName,a.formattedAddress)}async function N(s,o,e,a){const{InfoWindow:c}=await google.maps.importLibrary("maps");d=new c({position:s,content:B(e,a),maxWidth:250}),d.open(o),google.maps.event.addListener(d,"domready",function(){const v=document.querySelector(".create-note");v&&v.addEventListener("click",()=>{if(t.notes.find(_=>_.id===l.value.id&&_.user===t.user.ID)){g.value=!0,d.close();return}if(!t.user.ID){w.value=!0,d.close();return}u.value=!0})})}function B(s,o){return`
    <div class="info-window">
      <h6>${s}</h6>
      <p>${o}</p>
      <div class=info-window__button>
        <button class="create-note">新增筆記</button>
      </div>
    </div>`}I(),M(()=>t.userLocation,()=>{I(),f.setOptions({bounds:{north:t.userLocation.lat+.1,south:t.userLocation.lat-.1,east:t.userLocation.lng+.1,west:t.userLocation.lng-.1}})}),W(async()=>{const s=document.querySelector(".search-input input");await google.maps.importLibrary("places");const o={north:t.userLocation.lat+.1,south:t.userLocation.lat-.1,east:t.userLocation.lng+.1,west:t.userLocation.lng-.1};f=new google.maps.places.Autocomplete(s,{fields:["place_id","geometry","formatted_address","name","url","adr_address"],bounds:o}),f.addListener("place_changed",()=>{d&&d.close();const e=f.getPlace();if(!e.geometry||!e.geometry.location)return;e.geometry.viewport?i.fitBounds(e.geometry.viewport):(i.setCenter(e.geometry.location),i.setZoom(18));const a=b(e.adr_address);V({placeId:e.place_id,storeName:e.name,location:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},googlemapURL:e.url,address:e.formatted_address,city:a}),N(e.geometry.location,i,e.name,e.formatted_address)})});function Q(s){d.close(),u.value=!1;const o=s;if(l.value={user:t.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[],city:""},t.notes.find(e=>e.id===o.id&&e.user===t.user.ID)){g.value=!0;return}t.createNote(o)}function V({placeId:s,storeName:o,location:e,googlemapURL:a,address:c,city:v}){l.value.id=s,l.value.storeName=o,l.value.location=e,l.value.googlemapURL=a,l.value.address=c,l.value.city=v}function b(s){return new DOMParser().parseFromString(s,"text/html").querySelector(".region").textContent}return M(()=>t.user,()=>{l.value.user=t.user.ID}),(s,o)=>(z(),O("div",null,[n(k,{modelValue:L.value,"onUpdate:modelValue":o[0]||(o[0]=e=>L.value=e),class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},null,8,["modelValue"]),o[9]||(o[9]=p("div",{class:"separator row flex-center"},[p("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),p("div",{id:"map",onTouchstart:o[1]||(o[1]=S(()=>{},["stop"])),onMousedown:o[2]||(o[2]=S(()=>{},["stop"]))},null,32),n(y,{modelValue:u.value,"onUpdate:modelValue":o[4]||(o[4]=e=>u.value=e),persistent:""},{default:r(()=>[n(F,{isCreate:!0,"onUpdate:isCreate":o[3]||(o[3]=e=>u.value=e),noteInput:l.value,"onCreate:note":Q},null,8,["noteInput"])]),_:1},8,["modelValue"]),n(y,{modelValue:g.value,"onUpdate:modelValue":o[5]||(o[5]=e=>g.value=e)},{default:r(()=>[n(x,null,{default:r(()=>[n(C,{class:"row items-center"},{default:r(()=>[n(U,{name:"warning",color:"negative",size:"24px"}),o[7]||(o[7]=p("span",{class:"q-ml-sm"},"已經寫過這家店的筆記囉！",-1))]),_:1}),n(R,{align:"right"},{default:r(()=>[D(n(A,{flat:"",label:"OK",color:"primary"},null,512),[[h]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(y,{modelValue:w.value,"onUpdate:modelValue":o[6]||(o[6]=e=>w.value=e)},{default:r(()=>[n(x,{style:{width:"200px"}},{default:r(()=>[n(C,{class:"row items-center"},{default:r(()=>[n(U,{name:"warning",color:"negative",size:"24px"}),o[8]||(o[8]=p("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),n(R,{align:"right"},{default:r(()=>[D(n(A,{flat:"",label:"OK",color:"primary"},null,512),[[h]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Y=E($,[["__scopeId","data-v-d755c0f5"]]);export{Y as default};
