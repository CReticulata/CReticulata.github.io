import{Q as k,a as v,N as B,b as N,c as _,d as b,C as x}from"./Note-BQXv65cM.js";import{_ as q,j as W,r as m,t as C,v as z,k as E,l as u,m as n,x as P,w as r,o as R,Q as V,y as S,z as D}from"./index-C4kkKfCB.js";const O={__name:"MapView",setup(h){const l=W(),s=m({user:l.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:""}),c=m(!1),p=m(!1),f=m(!1);let i,d;async function w(){const o=l.userLocation,{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");i=new t(document.getElementById("map"),{zoom:18,center:o,mapId:"DEMO_MAP_ID"}),new e({map:i,position:o,title:"目前位置"}),i.addListener("click",a=>{a.placeId&&M(a.placeId,i)})}async function M(o,t){const{Place:e}=await google.maps.importLibrary("places"),a=new e({id:o,requestedLanguage:"zh_Hant"});await a.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName"]}),I(o,a.displayName,{lat:a.location.lat(),lng:a.location.lng()},a.googleMapsURI,a.formattedAddress),y(a.location,t,a.displayName,a.formattedAddress)}async function y(o,t,e,a){const{InfoWindow:g}=await google.maps.importLibrary("maps");d=new g({position:o,content:Q(e,a),maxWidth:250}),d.open(t),google.maps.event.addListener(d,"domready",function(){const L=document.querySelector(".create-note");L&&L.addEventListener("click",()=>{if(l.notes.find(A=>A.id===s.value.id)){p.value=!0,d.close();return}if(!l.user.ID){f.value=!0,d.close();return}c.value=!0})})}function Q(o,t){return`
    <div class="info-window">
      <h6>${o}</h6>
      <p>${t}</p>
      <div class=info-window__button>
        <button class="create-note">新增筆記</button>
      </div>
    </div>`}l.userLocation&&w(),C(()=>l.userLocation,()=>{w()}),z(async()=>{const o=document.querySelector(".search-input input");await google.maps.importLibrary("places");const t=new google.maps.places.Autocomplete(o,{fields:["place_id","geometry","formatted_address","name","url"]});t.addListener("place_changed",()=>{d&&d.close();const e=t.getPlace();!e.geometry||!e.geometry.location||(e.geometry.viewport?i.fitBounds(e.geometry.viewport):(i.setCenter(e.geometry.location),i.setZoom(18)),I(e.place_id,e.name,{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},e.url,e.formatted_address),y(e.geometry.location,i,e.name,e.formatted_address))})});function U(o){d.close(),c.value=!1;const t=o;if(s.value={user:l.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:""},l.notes.find(e=>e.id===t.id)){p.value=!0;return}l.createNote(t)}function I(o,t,e,a,g){s.value.id=o,s.value.storeName=t,s.value.location=e,s.value.googlemapURL=a,s.value.address=g}return C(()=>l.user,()=>{s.value.user=l.user.ID}),(o,t)=>(R(),E("div",null,[u("pre",null,P(s.value),1),n(k,{class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"}),t[6]||(t[6]=u("div",{class:"separator row flex-center"},[u("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),t[7]||(t[7]=u("div",{id:"map"},null,-1)),n(v,{modelValue:c.value,"onUpdate:modelValue":t[1]||(t[1]=e=>c.value=e),persistent:""},{default:r(()=>[n(B,{isCreate:!0,"onUpdate:isCreate":t[0]||(t[0]=e=>c.value=e),noteInput:s.value,"onCreate:note":U},null,8,["noteInput"])]),_:1},8,["modelValue"]),n(v,{modelValue:p.value,"onUpdate:modelValue":t[2]||(t[2]=e=>p.value=e)},{default:r(()=>[n(N,null,{default:r(()=>[n(_,{class:"row items-center"},{default:r(()=>[n(V,{name:"warning",color:"negative",size:"24px"}),t[4]||(t[4]=u("span",{class:"q-ml-sm"},"已經寫過這家店的筆記囉！",-1))]),_:1}),n(b,{align:"right"},{default:r(()=>[S(n(D,{flat:"",label:"OK",color:"primary"},null,512),[[x]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(v,{modelValue:f.value,"onUpdate:modelValue":t[3]||(t[3]=e=>f.value=e)},{default:r(()=>[n(N,{style:{width:"200px"}},{default:r(()=>[n(_,{class:"row items-center"},{default:r(()=>[n(V,{name:"warning",color:"negative",size:"24px"}),t[5]||(t[5]=u("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),n(b,{align:"right"},{default:r(()=>[S(n(D,{flat:"",label:"OK",color:"primary"},null,512),[[x]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},j=q(O,[["__scopeId","data-v-4248682a"]]);export{j as default};
