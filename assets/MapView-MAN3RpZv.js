import{Q as q,k as U,l as O,m as P}from"./QDialog-B8kMnmg2.js";import{_ as W,V as F,r as m,c as _,q as $,w as I,L as w,M as p,Z as d,Y as y,a1 as h,R as g,N as z,P as H,Q as Z,$ as N,a2 as K,a3 as T,a0 as Y}from"./index-CeEn8-o1.js";import{N as A,b as j,C as G}from"./Note-DInD2sjK.js";const J={key:0,class:"notes"},X={__name:"MapView",setup(ee){const n=F(),s=m({user:n.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",city:"",photos:[]}),k=m(""),u=m(!1),B=_(()=>n.notes.find(a=>a.id===s.value.id)),D=_(()=>n.notes.find(a=>a.id===s.value.id&&a.user===n.user.ID)),L=m(!1),f=m(!1);let r,l,v;async function b(){const a=n.userLocation,{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");r=new t(document.getElementById("map"),{zoom:18,center:a,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new e({map:r,position:a,title:"目前位置"}),M(),r.addListener("click",o=>{o.placeId&&C(o.placeId,r)})}async function M(){const{AdvancedMarkerElement:a}=await google.maps.importLibrary("marker");[...n.notes].map(e=>{const o=document.createElement("div");o.classList.add("tomato");const i=document.createElement("img");i.src=new URL("/favicon-tomato.png",import.meta.url).href,o.appendChild(i);const c=new a({map:r,position:{lat:e.location.lat,lng:e.location.lng},content:o,title:e.storeName,gmpClickable:!0});return c.placeId=e.id,c}).forEach(e=>{e.addEventListener("click",()=>{e.placeId&&C(e.placeId,r)})})}async function C(a,t){const{Place:e}=await google.maps.importLibrary("places"),o=new e({id:a,requestedLanguage:"zh_Hant"});await o.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName","adrFormatAddress"]});const i=E(o.adrFormatAddress);x({placeId:a,storeName:o.displayName,location:{lat:o.location.lat(),lng:o.location.lng()},googlemapURL:o.googleMapsURI,address:o.formattedAddress,city:i}),V(o.location,t,o.displayName,o.formattedAddress)}async function V(a,t,e,o){const{InfoWindow:i}=await google.maps.importLibrary("maps");l&&l.close(),l=new i({position:a,content:R(e,o,B.value,D.value),maxWidth:250}),l.open(t),google.maps.event.addListener(l,"domready",function(){const c=document.querySelector(".review-note"),S=document.querySelector(".create-note");c&&c.addEventListener("click",()=>{f.value=!0,u.value=!0}),S&&S.addEventListener("click",()=>{if(!n.user.ID){L.value=!0,l.close();return}f.value=!1,u.value=!0})})}function R(a,t,e=!1,o=!1){return`
    <div class="info-window">
      <h6>${a}</h6>
      <p>${t}</p>
      <div class=info-window__button>
        ${e?'<button class="review-note">查看筆記</button>':""}
        ${o?"":'<button class="create-note">新增筆記</button>'}
      </div>
    </div>`}$(async()=>{const a=document.querySelector(".search-input input");await google.maps.importLibrary("places");const t={north:n.userLocation.lat+.1,south:n.userLocation.lat-.1,east:n.userLocation.lng+.1,west:n.userLocation.lng-.1};v=new google.maps.places.Autocomplete(a,{fields:["place_id","geometry","formatted_address","name","url","adr_address"],bounds:t}),v.addListener("place_changed",()=>{l&&l.close();const e=v.getPlace();if(!e.geometry||!e.geometry.location)return;e.geometry.viewport?r.fitBounds(e.geometry.viewport):(r.setCenter(e.geometry.location),r.setZoom(18));const o=E(e.adr_address);x({placeId:e.place_id,storeName:e.name,location:{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()},googlemapURL:e.url,address:e.formatted_address,city:o}),V(e.geometry.location,r,e.name,e.formatted_address)})});function Q(a){l.close(),u.value=!1;const t=a;s.value={user:n.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[],city:""},n.createNote(t)}function x({placeId:a,storeName:t,location:e,googlemapURL:o,address:i,city:c}){s.value.id=a,s.value.storeName=t,s.value.location=e,s.value.googlemapURL=o,s.value.address=i,s.value.city=c}function E(a){return new DOMParser().parseFromString(a,"text/html").querySelector(".region").textContent}return b(),I(()=>n.userLocation,()=>{b(),v.setOptions({bounds:{north:n.userLocation.lat+.1,south:n.userLocation.lat-.1,east:n.userLocation.lng+.1,west:n.userLocation.lng-.1}})}),I(()=>n.user,()=>{s.value.user=n.user.ID}),I(()=>n.notes,()=>{M()}),(a,t)=>(p(),w("div",null,[d(q,{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=e=>k.value=e),class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},null,8,["modelValue"]),t[9]||(t[9]=y("div",{class:"separator row flex-center"},[y("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),y("div",{id:"map",onTouchstart:t[1]||(t[1]=h(()=>{},["stop"])),onMousedown:t[2]||(t[2]=h(()=>{},["stop"]))},null,32),d(U,{modelValue:u.value,"onUpdate:modelValue":t[6]||(t[6]=e=>u.value=e),persistent:!f.value},{default:g(()=>[f.value?(p(),w("div",J,[(p(!0),w(H,null,Z(N(n).notes.filter(e=>e.id===s.value.id),e=>(p(),w("div",{key:e.id+e.user},[d(A,{noteInput:e,"onUpdate:note":t[3]||(t[3]=o=>N(n).updateNote(o)),"onDelete:note":t[4]||(t[4]=o=>N(n).deleteNote(o))},null,8,["noteInput"])]))),128))])):(p(),z(A,{key:1,isCreate:!0,"onUpdate:isNoteOpen":t[5]||(t[5]=e=>u.value=e),noteInput:s.value,"onCreate:note":Q},null,8,["noteInput"]))]),_:1},8,["modelValue","persistent"]),d(U,{modelValue:L.value,"onUpdate:modelValue":t[7]||(t[7]=e=>L.value=e)},{default:g(()=>[d(O,{style:{width:"200px"}},{default:g(()=>[d(P,{class:"row items-center"},{default:g(()=>[d(K,{name:"warning",color:"negative",size:"24px"}),t[8]||(t[8]=y("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),d(j,{align:"right"},{default:g(()=>[T(d(Y,{flat:"",label:"OK",color:"primary"},null,512),[[G]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},ne=W(X,[["__scopeId","data-v-32a14671"]]);export{ne as default};
