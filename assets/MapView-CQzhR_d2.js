import{Q as J,k as U,l as V,m as X,n as ee}from"./QDialog-H_b5T_N9.js";import{_ as te,V as oe,r as p,c as E,w as k,L as g,M as c,Y as f,Z as s,O as ae,R as i,P as R,Q as D,a1 as Q,N as B,a2 as ne,a3 as se,S as q,U as P,a4 as le,a5 as re,a6 as F,$ as O,a7 as ie,a0 as de}from"./index-BHF4Pnes.js";import{N as W,b as ue,C as ce}from"./Note-Bw4BtXxa.js";const me={class:"autocomplete"},pe={key:0,class:"suggestion-list"},ge={class:"list"},fe={key:0,class:"notes"},ve={__name:"MapView",setup(we){const n=oe(),l=p({user:n.user.ID||"",id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",city:"",photos:[]}),v=p(""),w=p([]),m=p(!1),$=E(()=>n.notes.find(e=>e.id===l.value.id)),T=E(()=>n.notes.find(e=>e.id===l.value.id&&e.user===n.user.ID)),L=p(!1),y=p(!1);let r,u,N=[];async function b(){const e=n.userLocation,{Map:t}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:o}=await google.maps.importLibrary("marker");await google.maps.importLibrary("places"),r=new t(document.getElementById("map"),{zoom:18,center:e,mapId:"DEMO_MAP_ID",gestureHandling:"greedy"}),new o({map:r,position:e,title:"目前位置"}),A(),r.addListener("click",a=>{a.placeId&&S(a.placeId,r)})}async function A(){const{AdvancedMarkerElement:e}=await google.maps.importLibrary("marker");N.forEach(t=>{t.map=null}),N=[],N=[...n.notes].map(t=>{const o=document.createElement("div");o.classList.add("tomato");const a=document.createElement("img");a.src=new URL("/favicon-tomato.png",import.meta.url).href,o.appendChild(a);const d=new e({map:r,position:{lat:t.location.lat,lng:t.location.lng},content:o,title:t.storeName,gmpClickable:!0});return d.placeId=t.id,d}),N.forEach(t=>{t.addEventListener("click",()=>{t.placeId&&S(t.placeId,r)})})}async function S(e,t){const{Place:o}=await google.maps.importLibrary("places"),a=new o({id:e,requestedLanguage:"zh_Hant"});await a.fetchFields({fields:["formattedAddress","googleMapsURI","location","displayName","adrFormatAddress"]});const d=h(a.adrFormatAddress);M({placeId:e,storeName:a.displayName,location:{lat:a.location.lat(),lng:a.location.lng()},googlemapURL:a.googleMapsURI,address:a.formattedAddress,city:d}),_(a.location,t,a.displayName,a.formattedAddress)}async function _(e,t,o,a){const{InfoWindow:d}=await google.maps.importLibrary("maps");u&&u.close(),u=new d({position:e,content:z(o,a,$.value,T.value),maxWidth:250}),u.open(t),google.maps.event.addListener(u,"domready",function(){const I=document.querySelector(".review-note"),x=document.querySelector(".create-note");I&&I.addEventListener("click",()=>{y.value=!0,m.value=!0}),x&&x.addEventListener("click",()=>{if(!n.user.ID){L.value=!0,u.close();return}y.value=!1,m.value=!0})})}function z(e,t,o=!1,a=!1){return`
    <div class="info-window">
      <h6>${e}</h6>
      <p>${t}</p>
      <div class=info-window__button>
        ${o?'<button class="review-note">查看筆記</button>':""}
        ${a?"":'<button class="create-note">新增筆記</button>'}
      </div>
    </div>`}async function H(){if(v.value===""){w.value=[];return}const e={input:v.value,locationBias:{radius:100,center:{lat:n.userLocation.lat,lng:n.userLocation.lng}}},{suggestions:t}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(e);w.value=t.map(o=>o.placePrediction)}function Z(e){return e.Nq.Nh[3][0][0]}function K(e){return e.Nq.Nh[3][1][0]}async function Y(e){if(await e.fetchFields({fields:["id","viewport","location","formattedAddress","displayName","googleMapsURI","adrFormatAddress"]}),!e.viewport||!e.location)return;e.viewport?r.fitBounds(e.viewport):(r.setCenter(e.location),r.setZoom(18));const t=h(e.adrFormatAddress);M({placeId:e.id,storeName:e.displayName,location:{lat:e.location.lat(),lng:e.location.lng()},googlemapURL:e.googleMapsURI,address:e.formattedAddress,city:t}),_(e.location,r,e.displayName,e.formattedAddress),C()}function C(){v.value="",w.value=[]}function j(e){u.close(),m.value=!1;const t=e;l.value={user:n.user.ID,id:"",storeName:"",foodScore:0,serviceScore:0,pros:"",cons:"",location:{lat:0,lng:0},googlemapURL:"",address:"",photos:[],city:""},n.createNote(t)}function M({placeId:e,storeName:t,location:o,googlemapURL:a,address:d,city:I}){l.value.id=e,l.value.storeName=t,l.value.location=o,l.value.googlemapURL=a,l.value.address=d,l.value.city=I}function h(e){return new DOMParser().parseFromString(e,"text/html").querySelector(".region").textContent}function G(e){n.deleteNote(e),m.value=!1,u.close()}return b(),k(()=>n.userLocation,()=>{b()}),k(()=>n.user,()=>{l.value.user=n.user.ID}),k(()=>n.notes,()=>{A()}),(e,t)=>(c(),g("div",null,[f("div",me,[s(J,{modelValue:v.value,"onUpdate:modelValue":[t[0]||(t[0]=o=>v.value=o),H],onBlur:C,class:"search-input",outlined:"",placeholder:"在這裡搜尋",color:"red"},null,8,["modelValue"]),w.value.length>0?(c(),g("div",pe,[f("div",ge,[s(re,{bordered:"",separator:""},{default:i(()=>[(c(!0),g(R,null,D(w.value,(o,a)=>Q((c(),B(ne,{key:a,clickable:"",onClick:()=>Y(o.toPlace())},{default:i(()=>[s(se,null,{default:i(()=>[s(U,null,{default:i(()=>[q(P(Z(o)),1)]),_:2},1024),s(U,{caption:""},{default:i(()=>[q(P(K(o)),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[le]])),128))]),_:1})])])):ae("",!0)]),t[8]||(t[8]=f("div",{class:"separator row flex-center"},[f("div",{class:"text text-grey-7 q-py-sm"},"或直接點選地點")],-1)),f("div",{id:"map",onTouchstart:t[1]||(t[1]=F(()=>{},["stop"])),onMousedown:t[2]||(t[2]=F(()=>{},["stop"]))},null,32),s(V,{modelValue:m.value,"onUpdate:modelValue":t[5]||(t[5]=o=>m.value=o),persistent:!y.value},{default:i(()=>[y.value?(c(),g("div",fe,[(c(!0),g(R,null,D(O(n).notes.filter(o=>o.id===l.value.id),o=>(c(),g("div",{key:o.id+o.user},[s(W,{noteInput:o,"onUpdate:note":t[3]||(t[3]=a=>O(n).updateNote(a)),"onDelete:note":G},null,8,["noteInput"])]))),128))])):(c(),B(W,{key:1,isCreate:!0,"onUpdate:isNoteOpen":t[4]||(t[4]=o=>m.value=o),noteInput:l.value,"onCreate:note":j},null,8,["noteInput"]))]),_:1},8,["modelValue","persistent"]),s(V,{modelValue:L.value,"onUpdate:modelValue":t[6]||(t[6]=o=>L.value=o)},{default:i(()=>[s(X,{style:{width:"200px"}},{default:i(()=>[s(ee,{class:"row items-center"},{default:i(()=>[s(ie,{name:"warning",color:"negative",size:"24px"}),t[7]||(t[7]=f("span",{class:"q-ml-sm"},"請先登入！",-1))]),_:1}),s(ue,{align:"right"},{default:i(()=>[Q(s(de,{flat:"",label:"OK",color:"primary"},null,512),[[ce]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Le=te(ve,[["__scopeId","data-v-bcdb734f"]]);export{Le as default};
